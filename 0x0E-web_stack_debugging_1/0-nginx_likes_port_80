#!/bin/bash

# Update package list
apt-get update

# Install Nginx
apt-get install -y nginx

# Check Nginx configuration
nginx -t

# Start Nginx
systemctl start nginx

# Ensure Nginx starts on boot
systemctl enable nginx

# Check if Nginx is listening on port 80
if [ "$(ss -tln | grep ':80 ')" ]; then
    echo "Nginx is successfully running and listening on port 80."
else
    echo "Nginx is not listening on port 80. Attempting to fix..."
    
    # Edit Nginx configuration to listen on port 80
    sed -i 's/listen 80 default_server;/listen 80;/g' /etc/nginx/sites-available/default

    # Test Nginx configuration again
    nginx -t

    # Reload Nginx to apply changes
    systemctl reload nginx

    # Check if Nginx is now listening on port 80
    if [ "$(ss -tln | grep ':80 ')" ]; then
        echo "Nginx is now successfully listening on port 80 after fixing the configuration."
    else
        echo "Failed to fix the issue. Please check the Nginx configuration manually."
    fi
fi
